name: Backend CI/CD (Cloud Run)

on:
  push:
    branches: [ "main", "feature/login" ]

env:
  PROJECT_ID: foodcom-deploy # 배포 및 리소스 통합 프로젝트
  REGION: asia-northeast3
  REPO_NAME: foodcom-repo
  IMAGE_NAME: backend
  SERVICE_NAME: foodcom-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
    
    # Gradle Wrapper 실행 권한 부여
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Create GCP Key File
      run: |
        mkdir -p ./src/main/resources
        echo '${{ secrets.GCP_SA_KEY }}' > ./src/main/resources/foodcom-479117-988274ec0f1c.json

    - name: Create Test Properties
      run: |
        # Master DataSource for H2
        echo "spring.datasource.master.jdbc-url=jdbc:h2:mem:testdb" > ./src/main/resources/application.properties
        echo "spring.datasource.master.driver-class-name=org.h2.Driver" >> ./src/main/resources/application.properties
        echo "spring.datasource.master.username=sa" >> ./src/main/resources/application.properties
        echo "spring.datasource.master.password=" >> ./src/main/resources/application.properties
        
        # Slave DataSource for H2 (Same as Master for Test)
        echo "spring.datasource.slave.jdbc-url=jdbc:h2:mem:testdb" >> ./src/main/resources/application.properties
        echo "spring.datasource.slave.driver-class-name=org.h2.Driver" >> ./src/main/resources/application.properties
        echo "spring.datasource.slave.username=sa" >> ./src/main/resources/application.properties
        echo "spring.datasource.slave.password=" >> ./src/main/resources/application.properties
        
        # JPA & GCP Settings
        echo "spring.jpa.database-platform=org.hibernate.dialect.H2Dialect" >> ./src/main/resources/application.properties
        echo "spring.jpa.hibernate.ddl-auto=create-drop" >> ./src/main/resources/application.properties
        
        # Disable GCP Services for Tests
        echo "spring.cloud.gcp.sql.enabled=false" >> ./src/main/resources/application.properties
        echo "spring.cloud.gcp.trace.enabled=false" >> ./src/main/resources/application.properties
        echo "spring.cloud.gcp.metrics.enabled=false" >> ./src/main/resources/application.properties
        echo "spring.cloud.gcp.core.enabled=false" >> ./src/main/resources/application.properties
        echo "spring.cloud.gcp.security.iap.enabled=false" >> ./src/main/resources/application.properties
        echo "management.tracing.enabled=false" >> ./src/main/resources/application.properties
        
        echo "gcp.storage.bucket-name=test-bucket" >> ./src/main/resources/application.properties
        # JWT 설정 추가 (Dummy 값)
        echo "jwt.secret.key=dGhpcy1pcy1hLXRlc3Qtc2VjcmV0LWtleS1mb3ItYnVpbGQtdGVzdC1wdXJwb3Nlcw==" >> ./src/main/resources/application.properties
        echo "jwt.access.expiration=3600000" >> ./src/main/resources/application.properties
        echo "jwt.refresh.expiration=86400000" >> ./src/main/resources/application.properties

    - name: Create Prod Properties
      env:
        PROD_PROPS: ${{ secrets.APPLICATION_PROD_PROPERTIES }}
      run: |
        echo "$PROD_PROPS" > ./src/main/resources/application-prod.properties

    - name: Run Tests
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ./src/main/resources/foodcom-479117-988274ec0f1c.json
      run: ./gradlew test

    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker
      run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev

    - name: Build and Push Docker Image
      run: |
        docker buildx build --platform=linux/amd64 \
          -t asia-northeast3-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          -t asia-northeast3-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest \
          --push .

    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: ${{ env.SERVICE_NAME }}
        image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        region: ${{ env.REGION }}
        project_id: "foodcom-deploy" # 모든 리소스가 있는 프로젝트로 통합
        flags: --platform managed --allow-unauthenticated --add-cloudsql-instances foodcom-deploy:asia-northeast3:foodcom-db --vpc-connector projects/foodcom-deploy/locations/asia-northeast3/connectors/foodcom-connector --memory 1Gi --startup-probe=httpGet.path=/actuator/health/readiness,initialDelaySeconds=10,periodSeconds=10,failureThreshold=30
        env_vars: SPRING_PROFILES_ACTIVE=prod,MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED=true,SPRING_CLOUD_GCP_TRACE_ENABLED=true,MANAGEMENT_TRACING_SAMPLING_PROBABILITY=1.0,SPRING_DATASOURCE_URL=${{ secrets.DB_URL }},SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }},SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }},SPRING_CLOUD_GCP_SQL_ENABLED=false,CORS_ALLOWED_ORIGINS=https://foodcom-frontend-dfu4voiktq-du.a.run.app,http://localhost:5173,SPRING_DATA_REDIS_HOST=${{ secrets.REDIS_HOST }},SPRING_DATA_REDIS_PORT=${{ secrets.REDIS_PORT }},GCP_STORAGE_BUCKET_NAME=${{ secrets.GCP_STORAGE_BUCKET_NAME }},SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE=10MB,SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE=50MB
