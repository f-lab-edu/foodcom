name: Backend CI/CD (Cloud Run)

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: flawless-star-480611-t3
  REGION: asia-northeast3
  REPO_NAME: foodcom-repo
  IMAGE_NAME: backend
  SERVICE_NAME: foodcom-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
    
    # Gradle Wrapper 실행 권한 부여
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Create GCP Key File
      run: |
        mkdir -p ./src/main/resources
        echo '${{ secrets.GCP_SA_KEY }}' > ./src/main/resources/foodcom-479117-988274ec0f1c.json

    - name: Create Test Properties
      run: |
        echo "spring.datasource.url=jdbc:h2:mem:testdb" > ./src/main/resources/application.properties
        echo "spring.datasource.driverClassName=org.h2.Driver" >> ./src/main/resources/application.properties
        echo "spring.datasource.username=sa" >> ./src/main/resources/application.properties
        echo "spring.datasource.password=" >> ./src/main/resources/application.properties
        echo "spring.jpa.database-platform=org.hibernate.dialect.H2Dialect" >> ./src/main/resources/application.properties
        echo "spring.jpa.hibernate.ddl-auto=create-drop" >> ./src/main/resources/application.properties
        echo "spring.jpa.hibernate.ddl-auto=create-drop" >> ./src/main/resources/application.properties
        # GCS 설정 (GcsConfig, StorageService에서 필요)
        echo "spring.cloud.gcp.storage.credentials.location=classpath:foodcom-479117-988274ec0f1c.json" >> ./src/main/resources/application.properties
        echo "spring.cloud.gcp.storage.project-id=foodcom-Deploy" >> ./src/main/resources/application.properties
        echo "spring.cloud.gcp.sql.enabled=false" >> ./src/main/resources/application.properties
        echo "gcp.storage.key-file-path=classpath:foodcom-479117-988274ec0f1c.json" >> ./src/main/resources/application.properties
        echo "gcp.storage.bucket-name=test-bucket" >> ./src/main/resources/application.properties
        # JWT 설정 추가 (Dummy 값)
        echo "jwt.secret.key=dGhpcy1pcy1hLXRlc3Qtc2VjcmV0LWtleS1mb3ItYnVpbGQtdGVzdC1wdXJwb3Nlcw==" >> ./src/main/resources/application.properties
        echo "jwt.access.expiration=3600000" >> ./src/main/resources/application.properties
        echo "jwt.refresh.expiration=86400000" >> ./src/main/resources/application.properties

    - name: Run Tests
      run: ./gradlew test

    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker
      run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev

    - name: Build and Push Docker Image
      run: |
        docker buildx build --platform=linux/amd64 \
          -t asia-northeast3-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          -t asia-northeast3-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest \
          --push .

    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: ${{ env.SERVICE_NAME }}
        image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        region: ${{ env.REGION }}
        project_id: ${{ env.PROJECT_ID }} # 명시적으로 프로젝트 ID 지정
        flags: --platform managed --allow-unauthenticated
        env_vars: SPRING_PROFILES_ACTIVE=prod,SPRING_CLOUD_GCP_TRACE_ENABLED=true,MANAGEMENT_TRACING_SAMPLING_PROBABILITY=1.0
